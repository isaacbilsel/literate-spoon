# API Endpoints — Frontend Integration Guide

This file documents the Flask API implemented in `main.py` with concrete request/response shapes, auth requirements, and example usage for a React frontend.

Base URL (development): http://localhost:5001

CORS: The Flask app allows origins including `http://localhost:3000` and the configured `NETLIFY_DOMAIN`.

Authentication: JWT Bearer tokens are used. Include header:

Authorization: Bearer {accessToken}

Tokens expire after ~15 minutes. Use `/api/auth/refresh` to get a new token.

---

## Quick React integration notes

- Store `accessToken` in memory or secure storage (recommended: in-memory or httpOnly cookie if implemented). LocalStorage is possible but vulnerable to XSS.
- Include `Authorization` header in all protected requests:

  headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }

- On 401 responses, redirect to login or call `/api/auth/refresh` to obtain a new token if your front-end holds a refresh token.
- Example fetch wrapper (simplified):

```js
async function apiFetch(path, { method = 'GET', body, token } = {}) {
  const res = await fetch(`http://localhost:5001${path}`, {
    method,
    headers: {
      'Content-Type': 'application/json',
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
    },
    body: body ? JSON.stringify(body) : undefined,
  });

  const json = await res.json().catch(() => null);
  if (!res.ok) throw { status: res.status, body: json };
  return json;
}
```

---

## Endpoints

### Authentication

#### POST /api/auth/register
- Auth: No
- Purpose: Create a new user and optional profile
- Request JSON:
```json
{
  "email": "user@example.com",
  "password": "strongPwd123",
  "firstName": "Jane",
  "gender": "F",
  "zipCode": "12345"
}
```
- Success (201) Response:
```json
{
  "user": { "id": 1, "email": "user@example.com" },
  "accessToken": "<JWT>",
  "refreshTokenSetCookie": false
}
```
- Errors: 400 (missing fields), 409 (email exists)
- Notes: The endpoint creates a `Profile` record if `firstName`/`gender`/`zipCode` are provided.

---

#### POST /api/auth/login
- Auth: No
- Purpose: Authenticate and receive access token
- Request JSON:
```json
{ "email": "user@example.com", "password": "strongPwd123" }
```
- Success (200) Response:
```json
{ "user": {"id": 1, "email": "user@example.com"}, "accessToken": "<JWT>", "refreshTokenSetCookie": false }
```
- Errors: 400 (missing), 401 (invalid credentials)

---

#### GET /api/auth/me
- Auth: Yes (Bearer)
- Purpose: Return current user and profile
- Success (200) Response:
```json
{
  "user": { "id": 1, "email": "user@example.com", "role": "user", "created_at": "2025-11-18T..." },
  "profile": { /* profile fields or null */ }
}
```
- Errors: 401 (no/invalid token)

---

#### POST /api/auth/logout
- Auth: Yes (recommended), but functionally stateless
- Purpose: Frontend signal to clear client-side auth state
- Response: 200
```json
{ "message": "Logged out successfully" }
```

---

#### POST /api/auth/refresh
- Auth: Yes (current token required)
- Purpose: Issue a new access token
- Response (200):
```json
{ "accessToken": "<new JWT>", "refreshTokenSetCookie": false }
```
- Errors: 401 if token invalid/expired

---

### Profile

#### GET /api/profile
- Auth: Yes
- Purpose: Get the authenticated user's profile
- Response (200):
```json
{
  "id": 1,
  "userId": 1,
  "firstName": "Jane",
  "gender": "F",
  "zipCode": "12345",
  "bio": "...",
  "createdAt": "2025-11-18T..."
}
```
- Errors: 401, 404 (no profile found)

---

#### PUT/PATCH /api/profile
- Auth: Yes
- Purpose: Update profile fields
- Request JSON (partial allowed):
```json
{ "firstName": "Jane", "gender": "F", "zipCode": "12345", "bio": "I like salads" }
```
- Response (200):
```json
{ "message": "Profile updated successfully", "profile": { /* updated profile */ } }
```
- Errors: 401, 404

---

### Recipes

#### POST /api/recipes
- Auth: No (the implementation accepts unauthenticated requests)
- Purpose: Return personalized recipes for the provided user metrics and preferences
- Request JSON (example):
```json
{
  "height_cm": 180,
  "weight_kg": 75,
  "allergies": ["peanuts"],
  "food_preferences": "Mediterranean",
  "diet_goals": "weight loss"
}
```
- Success (200) Response:
```json
{
  "success": true,
  "user_metrics": { /* derived metrics */ },
  "parsed_ingredients": "...",
  "recipe_count": 4,
  "recipes": [ /* recipe objects */ ]
}
```
- Errors: 400 (invalid input), 500 (external API error)
- Notes: Responses include `user_metrics` generated by the service and an array of recipes. External API failures return a 500 with `type: "external_api_error"`.

---

### Meal Plans

#### GET /api/meal-plans
- Auth: Yes
- Purpose: List meal plans owned by the user
- Response (200):
```json
{ "meal_plans": [ { /* mealPlan */ } ] }
```

---

#### POST /api/meal-plans
- Auth: Yes
- Purpose: Create a new meal plan
- Request JSON (example):
```json
{ "name": "Weekly Plan", "description": "Healthy meals", "meals": "[]" }
```
- Response (201):
```json
{ "message": "Meal plan created", "meal_plan": { /* meal plan */ } }
```

---

#### GET /api/meal-plans/:id
- Auth: Yes
- Purpose: Fetch a single meal plan
- Response (200): meal plan JSON
- Errors: 404 if not found, 401 if unauthorized

---

#### PUT/PATCH /api/meal-plans/:id
- Auth: Yes
- Purpose: Update meal plan
- Request JSON (partial allowed): `{ "name": "", "description": "", "meals": "[...]" }`
- Response (200): `{ "message": "Meal plan updated", "meal_plan": {...} }`

---

#### POST /api/meal-plans/:id/activate
- Auth: Yes
- Purpose: Mark this meal plan as active (deactivates others)
- Response (200): `{ "message": "Meal plan activated", "meal_plan": {...} }`

---

#### GET /api/meal-plans/:id/grocery-list
- Auth: Yes
- Purpose: Retrieve the grocery list associated with a meal plan
- Response (200): grocery list JSON
- Errors: 404 if not found

---

### Grocery Lists

#### GET /api/grocery-lists
- Auth: Yes
- Purpose: List grocery lists for user
- Response (200): `{ "grocery_lists": [ ... ] }`

---

#### POST /api/grocery-lists
- Auth: Yes
- Purpose: Create grocery list
- Request JSON: `{ "mealPlanId": 1, "items": "[\"milk\",\"eggs\"]" }`
- Response (201): `{ "message": "Grocery list created", "grocery_list": {...} }`

---

#### GET /api/grocery-lists/:id
- Auth: Yes
- Purpose: Get grocery list by id
- Response (200): grocery list JSON

---

#### PUT/PATCH /api/grocery-lists/:id
- Auth: Yes
- Purpose: Update grocery list
- Request JSON: `{ "items": "[...]" }`
- Response (200): `{ "message": "Grocery list updated", "grocery_list": {...} }`

---

### Chat

#### POST /api/chat/parse
- Auth: Yes
- Purpose: Send a chat message and receive AI-style response (placeholder implementation)
- Request JSON: `{ "message": "I want vegetarian meals for weight loss" }`
- Response (200):
```json
{ "message": "I want...", "response": "I received...", "chat_id": 1 }
```
- Notes: The server stores chat messages in `ChatMessage`.

---

#### GET /api/chat/history
- Auth: Yes
- Purpose: Get all chat messages for the authenticated user
- Response (200): `{ "chat_history": [ { /* message */ } ] }`

---

### Utility / Health

#### GET /health
- Auth: No
- Purpose: Simple health check for uptime and timestamp
- Response (200):
```json
{ "status": "ok", "uptime_seconds": 123, "timestamp": "2025-11-18T..." }
```

---

## Error formats

- Generic error object returned on many failures:
```json
{ "error": "Error message", "field": "optionalFieldName" }
```
- For validation errors in `/api/recipes` the service returns:
```json
{ "success": false, "error": "Message", "field": "fieldName" }
```
- For server or external API errors:
```json
{ "success": false, "error": "message", "type": "external_api_error" }
```

---

## Practical frontend tips

- Login/Register: call `/api/auth/login` or `/api/auth/register`, store the returned `accessToken` and attach it to subsequent protected requests.
- Token expiry: watch for 401s — either redirect to login or call `/api/auth/refresh` if you retain the original token.
- Profile flow: after login, call `GET /api/auth/me` to retrieve user + profile and keep in app state.
- Creating content: after POST (create meal plan or grocery list) the endpoints return the created object for local state update.
- IDs: Many endpoints return numeric `id` fields — use these to navigate to details or to activate/update.
- Dates: Timestamps are ISO strings (use `new Date(isoString)` in JS).

---

## Where to check code for changes

- Endpoint implementations: `main.py`
- DB models & `to_dict()` shapes: `app_models.py`
- Business logic & external API calls: `app_services.py`

---

If you want, I can also:
- Add sample React hook files (useAuth, useApi) that wrap token storage + refresh.
- Generate OpenAPI (Swagger) spec from `main.py` for automatic client generation.

